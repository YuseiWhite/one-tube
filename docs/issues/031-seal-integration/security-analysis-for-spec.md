### セキュリティリスク分析と対策

#### 攻撃リスクと対策一覧

| 攻撃リスク | リスクレベル | 攻撃の説明 | 対策 |
|-----------|------------|-----------|------|
| **マスター鍵の漏洩** | 🔴 致命的 | アプリ側でマスター鍵を保持し、漏洩により全動画が復号可能になる | • マスター鍵はSeal key serverが保持（アプリ側は保持しない）<br>• 侵害時のblast radiusを最小化<br>• アプリ側で鍵を生成・管理しない |
| **セッションキーの漏洩・ハイジャック** | 🟡 重大 | SessionKeyが漏洩し、不正なユーザーが動画にアクセス可能になる | • SessionKeyは1分の有効期限（SealのttlMin制約）<br>• 本番環境ではSessionKeyをサーバー側に永続化しない（client-side保存またはin-memory）<br>• HTTPS必須（本番環境）<br>• セッション検証時にNFT所有確認を再実行 |
| **NFT所有確認のバイパス** | 🔴 致命的 | NFTを所有していないユーザーが動画にアクセス可能になる | • `seal_approve_nft`関数でon-chainでNFT所有確認<br>• `tx_context::sender(ctx)`でトランザクションのsenderを取得（PTBのsenderと一貫性を保つ）<br>• Seal key serverが`dry_run_transaction_block`で評価<br>• セッション検証時に毎回NFT所有確認を実行 |
| **リプレイ攻撃** | 🟡 重大 | 過去のセッションIDやPTBを再利用して動画にアクセス | • セッション期限（1分）で自動無効化<br>• セッション検証時にNFT所有確認を再実行（NFTを手放した場合は即座に拒否）<br>• SessionKeyの有効期限管理 |
| **中間者攻撃（MITM）** | 🟡 重大 | 通信経路でSessionKeyやencryptedObjectを盗聴・改ざん | • HTTPS必須（本番環境）<br>• Seal SDKが自動的にデータ改ざん検知（認証タグ検証）<br>• SessionKeyは暗号化された通信経路で送信 |
| **データ改ざん** | 🟡 重大 | encryptedObjectやセッション情報が改ざんされる | • Seal SDKが自動的に認証タグ検証（AES-256-GCMまたはHMAC-CTR）<br>• データ改ざんが検知された場合は復号失敗<br>• セッション情報の整合性チェック |
| **パディングオラクル攻撃** | 🟢 低 | CBCモードのパディングエラーを利用した攻撃 | • Seal SDKがAES-256-GCMまたはHMAC-CTRを使用（パディング不要）<br>• ストリーム暗号ベースでパディングオラクル攻撃が成立しない |
| **タイミング攻撃** | 🟢 低 | 処理時間の差から情報を推測 | • NFT所有確認はon-chainで実行（処理時間の差が攻撃に利用されにくい）<br>• エラーメッセージを統一（情報漏洩を防ぐ） |
| **セッション固定攻撃** | 🟡 重大 | 攻撃者が生成したセッションIDを被害者に使用させる | • SessionKeyはユーザーが署名する必要がある<br>• セッションIDは`SHA-256(userAddress + nftId + timestamp)`で生成（予測困難）<br>• セッション検証時にNFT所有確認を再実行 |
| **権限昇格攻撃** | 🔴 致命的 | 権限のないユーザーが動画にアクセス可能になる | • `seal_approve_nft`関数でNFT所有確認（on-chainで検証）<br>• `tx_context::sender(ctx)`でトランザクションのsenderを取得<br>• blobIdはセッション情報から内部で取得（ユーザーからは受け取らない） |
| **サービス拒否攻撃（DoS）** | 🟡 重大 | 大量のリクエストでサーバーを過負荷にする | • セッション期限（1分）で自動無効化（リソースの自動解放）<br>• セッション検証時に期限切れセッションを自動削除<br>• エラーハンドリングで適切にリソースを解放 |
| **インジェクション攻撃** | 🟡 重大 | 悪意のある入力でシステムを破壊 | • Move言語の型安全性（Moveモジュールでのインジェクション防止）<br>• 入力検証（blobId、sessionId等の形式チェック）<br>• Seal SDKが自動的に入力検証 |
| **情報漏洩（ログ経由）** | 🟡 重大 | ログにSessionKeyや鍵情報が出力され、漏洩する | • 本番環境では`DEV_MODE=false`に設定<br>• SessionKeyは通常ログに出力しない<br>• DEV_MODE時のみ詳細ログを出力（マスク済み）<br>• 外部APIレスポンス本文はDEBUGログのみ |
| **リソース枯渇攻撃** | 🟡 重大 | 大量のセッション作成でメモリやストレージを枯渇させる | • セッション期限（1分）で自動無効化<br>• 期限切れセッションの自動削除<br>• MVPは「サーバープロセス1つ」「同時アクセス少ない」前提 |
| **Key Serverのなりすまし** | 🟡 重大 | 悪意のあるKey Serverが復号鍵を発行する | • Key serverのobject IDを環境変数で管理<br>• `verifyKeyServers: true`でKey serverの検証を有効化可能<br>• Seal key serverが`dry_run_transaction_block`で`seal_approve_nft`を評価（なりすまし防止） |
| **PTBの改ざん** | 🟡 重大 | PTBが改ざんされ、異なるNFT所有確認が実行される | • PTBはセッション作成時に固定され、セッション情報に保存<br>• Seal key serverが`dry_run_transaction_block`でPTBを評価<br>• PTBの整合性チェック |
| **blobIdの操作** | 🟡 重大 | ユーザーがblobIdを操作して、権限のない動画にアクセス | • blobIdはセッション情報から内部で取得（ユーザーからは受け取らない）<br>• NFTメタデータからblobIdを解決<br>• セッション検証時にNFT所有確認を再実行 |